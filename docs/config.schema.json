{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://rustic-ai.local/config.schema.json",
  "title": "Rustic-AI Config",
  "type": "object",
  "required": [
    "mode",
    "features",
    "mcp",
    "plugins",
    "skills",
    "workflows",
    "storage",
    "summarization",
    "rules",
    "providers",
    "agents",
    "tools",
    "taxonomy"
  ],
  "properties": {
    "mode": {
      "type": "string",
      "enum": ["direct", "project"]
    },
    "features": {
      "type": "object",
      "required": [
        "mcp_enabled",
        "skills_enabled",
        "plugins_enabled",
        "workflows_enabled",
        "triggers_enabled"
      ],
      "properties": {
        "mcp_enabled": { "type": "boolean" },
        "skills_enabled": { "type": "boolean" },
        "plugins_enabled": { "type": "boolean" },
        "workflows_enabled": { "type": "boolean" },
        "triggers_enabled": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "mcp": {
      "type": "object",
      "required": ["servers"],
      "properties": {
        "servers": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "name",
              "command",
              "args",
              "env",
              "working_directory",
              "startup_timeout_seconds",
              "protocol_version"
            ],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "command": { "type": "string", "minLength": 1 },
              "args": {
                "type": "array",
                "items": { "type": "string" }
              },
              "env": {
                "type": "object",
                "additionalProperties": { "type": "string" }
              },
              "working_directory": { "type": ["string", "null"] },
              "startup_timeout_seconds": { "type": "integer", "minimum": 1 },
              "protocol_version": { "type": "string", "minLength": 1 }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "plugins": {
      "type": "object",
      "required": ["directories", "manifest_file_name", "max_discovery_depth"],
      "properties": {
        "directories": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "manifest_file_name": { "type": "string", "minLength": 1 },
        "max_discovery_depth": { "type": "integer", "minimum": 1, "maximum": 32 }
      },
      "additionalProperties": false
    },
    "skills": {
      "type": "object",
      "required": [
        "directories",
        "max_discovery_depth",
        "script_execution_mode",
        "default_timeout_seconds",
        "sandbox"
      ],
      "properties": {
        "directories": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "max_discovery_depth": { "type": "integer", "minimum": 1, "maximum": 32 },
        "script_execution_mode": { "type": "string", "enum": ["disabled", "host", "sandbox"] },
        "default_timeout_seconds": { "type": "integer", "minimum": 1 },
        "sandbox": {
          "type": "object",
          "required": ["enabled", "sandbox_type"],
          "properties": {
            "enabled": { "type": "boolean" },
            "sandbox_type": { "type": "string", "minLength": 1 }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "workflows": {
      "type": "object",
      "required": [
        "directories",
        "max_discovery_depth",
        "default_timeout_seconds",
        "max_recursion_depth",
        "max_steps_per_run"
      ],
      "properties": {
        "directories": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "max_discovery_depth": { "type": "integer", "minimum": 1, "maximum": 32 },
        "default_timeout_seconds": { "type": "integer", "minimum": 1 },
        "max_recursion_depth": { "type": ["integer", "null"], "minimum": 1, "maximum": 256 },
        "max_steps_per_run": { "type": ["integer", "null"], "minimum": 1, "maximum": 10000 }
      },
      "additionalProperties": false
    },
    "storage": {
      "type": "object",
      "required": [
        "backend",
        "default_root_dir_name",
        "project_database_file",
        "connection_string_prefix",
        "global_settings_file",
        "global_data_subdir",
        "pool_size",
        "sqlite",
        "postgres"
      ],
      "properties": {
        "backend": {
          "type": "string",
          "enum": ["sqlite", "postgres", "custom"]
        },
        "default_root_dir_name": { "type": "string", "minLength": 1 },
        "project_data_path": { "type": ["string", "null"] },
        "project_database_file": { "type": "string", "minLength": 1 },
        "connection_string_prefix": { "type": "string", "minLength": 1 },
        "global_root_path": { "type": ["string", "null"] },
        "global_settings_file": { "type": "string", "minLength": 1 },
        "global_data_subdir": { "type": "string", "minLength": 1 },
        "pool_size": { "type": "integer", "minimum": 1 },
        "sqlite": {
          "type": "object",
          "required": [
            "busy_timeout_ms",
            "journal_mode",
            "synchronous",
            "foreign_keys"
          ],
          "properties": {
            "busy_timeout_ms": { "type": "integer", "minimum": 1 },
            "journal_mode": { "type": "string", "minLength": 1 },
            "synchronous": { "type": "string", "minLength": 1 },
            "foreign_keys": { "type": "boolean" }
          },
          "additionalProperties": false
        },
        "postgres": {
          "type": "object",
          "required": ["connection_url", "schema_name"],
          "properties": {
            "connection_url": { "type": ["string", "null"] },
            "schema_name": { "type": ["string", "null"] }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "summarization": {
      "type": "object",
      "required": [
        "enabled",
        "provider_name",
        "max_context_tokens",
        "summary_max_tokens"
      ],
      "properties": {
        "enabled": { "type": "boolean" },
        "provider_name": { "type": ["string", "null"] },
        "max_context_tokens": { "type": "integer", "minimum": 1 },
        "summary_max_tokens": { "type": "integer", "minimum": 1 }
      },
      "additionalProperties": false
    },
    "rules": {
      "type": "object",
      "required": [
        "global_rules_path",
        "project_rules_folder",
        "additional_search_paths",
        "recursive_discovery",
        "max_discovery_depth",
        "use_gitignore",
        "rule_extensions",
        "rule_file_names",
        "context_file_patterns",
        "context_extensions",
        "topic_debounce_interval_secs",
        "topic_similarity_threshold",
        "global_files",
        "project_files",
        "topic_files",
        "context_files",
        "discovered_rules"
      ],
      "properties": {
        "global_rules_path": { "type": "string" },
        "project_rules_folder": { "type": "string" },
        "additional_search_paths": {
          "type": "array",
          "items": { "type": "string" }
        },
        "recursive_discovery": { "type": "boolean" },
        "max_discovery_depth": { "type": "integer", "minimum": 0 },
        "use_gitignore": { "type": "boolean" },
        "rule_extensions": {
          "type": "array",
          "items": { "type": "string" }
        },
        "rule_file_names": {
          "type": "array",
          "items": { "type": "string" }
        },
        "context_file_patterns": {
          "type": "array",
          "items": { "type": "string" }
        },
        "context_extensions": {
          "type": "array",
          "items": { "type": "string" }
        },
        "topic_debounce_interval_secs": { "type": "integer", "minimum": 0 },
        "topic_similarity_threshold": { "type": "number", "minimum": 0, "maximum": 1 },
        "global_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "project_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "topic_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "context_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "discovered_rules": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "path",
              "scope",
              "globs",
              "always_apply",
              "applicability",
              "topics"
            ],
            "properties": {
              "path": { "type": "string" },
              "scope": { "type": "string", "enum": ["global", "project", "topic"] },
              "description": { "type": ["string", "null"] },
              "globs": {
                "type": "array",
                "items": { "type": "string" }
              },
              "always_apply": { "type": "boolean" },
              "applicability": {
                "type": "string",
                "enum": ["general", "context_specific"]
              },
              "topics": {
                "type": "array",
                "items": { "type": "string" }
              },
              "priority": { "type": ["integer", "null"] }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "permissions": {
      "type": "object",
      "required": [
        "default_tool_permission",
        "ask_decisions_persist_scope",
        "remember_denied_duration_secs",
        "globally_allowed_paths",
        "project_allowed_paths",
        "global_command_patterns",
        "project_command_patterns",
        "pending_tool_timeout_secs",
        "sudo_cache_ttl_secs",
        "permission_cache_max_entries",
        "read_only_shell_write_patterns"
      ],
      "properties": {
        "default_tool_permission": {
          "type": "string",
          "enum": ["allow", "ask", "deny"]
        },
        "ask_decisions_persist_scope": {
          "type": "string",
          "enum": ["session", "project", "global"]
        },
        "remember_denied_duration_secs": {
          "type": "integer",
          "minimum": 0
        },
        "globally_allowed_paths": {
          "type": "array",
          "items": { "type": "string" }
        },
        "project_allowed_paths": {
          "type": "array",
          "items": { "type": "string" }
        },
        "global_command_patterns": {
          "$ref": "#/$defs/command_pattern_config"
        },
        "project_command_patterns": {
          "$ref": "#/$defs/command_pattern_config"
        },
        "pending_tool_timeout_secs": {
          "type": "integer",
          "minimum": 1
        },
        "sudo_cache_ttl_secs": {
          "type": "integer",
          "minimum": 1
        },
        "permission_cache_max_entries": {
          "type": "integer",
          "minimum": 0
        },
        "read_only_shell_write_patterns": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": false
    },
    "providers": {
      "type": "array",
      "minItems": 1,
      "items": {
        "oneOf": [
          {
            "type": "object",
            "required": [
              "name",
              "provider_type",
              "auth_mode",
              "model",
              "base_url"
            ],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "provider_type": { "const": "open_ai" },
              "auth_mode": { "type": "string", "enum": ["api_key", "subscription", "none"] },
              "model": { "type": "string", "minLength": 1 },
              "api_key_env": { "type": ["string", "null"] },
              "base_url": { "type": "string", "minLength": 1 },
              "settings": {
                "type": ["object", "null"],
                "additionalProperties": true
              }
            },
            "additionalProperties": false
          },
          {
            "type": "object",
            "required": ["name", "provider_type", "auth_mode"],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "provider_type": {
                "type": "string",
                "enum": ["anthropic", "grok", "google", "z_ai", "ollama", "custom"]
              },
              "auth_mode": { "type": "string", "enum": ["api_key", "subscription", "none"] },
              "model": { "type": ["string", "null"] },
              "api_key_env": { "type": ["string", "null"] },
              "base_url": { "type": ["string", "null"] },
              "settings": {
                "type": ["object", "null"],
                "additionalProperties": true
              }
            },
            "additionalProperties": false
          }
        ]
      }
    },
    "agents": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["name", "provider", "tools", "skills"],
        "properties": {
          "name": { "type": "string", "minLength": 1 },
          "provider": { "type": "string", "minLength": 1 },
          "tools": {
            "type": "array",
            "items": { "type": "string" }
          },
          "skills": {
            "type": "array",
            "items": { "type": "string" }
          },
          "system_prompt_template": { "type": ["string", "null"] },
          "temperature": { "type": "number" },
          "max_tokens": { "type": "integer", "minimum": 1 },
          "context_window_size": { "type": "integer", "minimum": 1 },
          "max_tool_rounds": { "type": ["integer", "null"], "minimum": 0 },
          "max_tools_per_round": { "type": ["integer", "null"], "minimum": 0 },
          "max_total_tool_calls_per_turn": { "type": ["integer", "null"], "minimum": 0 },
          "max_turn_duration_seconds": { "type": ["integer", "null"], "minimum": 0 },
          "permission_mode": { "type": "string", "enum": ["read_only", "read_write"] },
          "allow_sub_agent_calls": { "type": "boolean" },
          "max_sub_agent_depth": { "type": ["integer", "null"], "minimum": 1 },
          "sub_agent_context_window_size": { "type": ["integer", "null"], "minimum": 1 },
          "sub_agent_max_context_tokens": { "type": ["integer", "null"], "minimum": 1 }
        },
        "additionalProperties": false
      }
    },
    "tools": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "name",
          "enabled",
          "permission_mode",
          "timeout_seconds",
          "allowed_commands",
          "denied_commands",
          "working_dir",
          "custom_working_dir",
          "env_passthrough",
          "stream_output",
          "require_sudo",
          "privileged_command_patterns",
          "read_only_blocked_patterns"
        ],
        "properties": {
          "name": { "type": "string" },
          "enabled": { "type": "boolean" },
          "permission_mode": { "type": "string", "enum": ["allow", "ask", "deny"] },
          "timeout_seconds": { "type": "integer", "minimum": 1 },
          "allowed_commands": {
            "type": "array",
            "items": { "type": "string" }
          },
          "denied_commands": {
            "type": "array",
            "items": { "type": "string" }
          },
          "working_dir": {
            "type": "string",
            "enum": ["current", "project_root", "custom_path"]
          },
          "custom_working_dir": { "type": ["string", "null"] },
          "env_passthrough": { "type": "boolean" },
          "stream_output": { "type": "boolean" },
          "require_sudo": { "type": "boolean" },
          "privileged_command_patterns": {
            "type": "array",
            "items": { "type": "string" }
          },
          "read_only_blocked_patterns": {
            "type": "array",
            "items": { "type": "string" }
          }
        },
        "additionalProperties": false
      }
    },
    "taxonomy": {
      "type": "object",
      "required": ["baskets"],
      "properties": {
        "baskets": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "sub_baskets"],
            "properties": {
              "name": { "type": "string" },
              "sub_baskets": {
                "type": "array",
                "items": { "type": "string" }
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    }
  },
  "$defs": {
    "command_pattern_config": {
      "type": "object",
      "required": ["allow", "ask", "deny"],
      "properties": {
        "allow": {
          "type": "array",
          "items": { "type": "string" }
        },
        "ask": {
          "type": "array",
          "items": { "type": "string" }
        },
        "deny": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
