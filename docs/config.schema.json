{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://rustic-ai.local/config.schema.json",
  "title": "Rustic-AI Config",
  "type": "object",
  "required": [
    "mode",
    "features",
    "retrieval",
    "dynamic_routing",
    "mcp",
    "plugins",
    "skills",
    "workflows",
    "storage",
    "summarization",
    "rules",
    "providers",
    "agents",
    "tools",
    "taxonomy"
  ],
  "properties": {
    "mode": {
      "type": "string",
      "enum": ["direct", "project"]
    },
    "features": {
      "type": "object",
      "required": [
        "mcp_enabled",
        "skills_enabled",
        "plugins_enabled",
        "workflows_enabled",
        "triggers_enabled",
        "learning_enabled",
        "indexing_enabled",
        "vector_enabled",
        "rag_enabled",
        "aggressive_summary_enabled",
        "todo_tracking_enabled",
        "sub_agent_parallel_enabled",
        "sub_agent_output_caching_enabled",
        "dynamic_routing_enabled"
      ],
      "properties": {
        "mcp_enabled": { "type": "boolean" },
        "skills_enabled": { "type": "boolean" },
        "plugins_enabled": { "type": "boolean" },
        "workflows_enabled": { "type": "boolean" },
        "triggers_enabled": { "type": "boolean" },
        "learning_enabled": { "type": "boolean" },
        "indexing_enabled": { "type": "boolean" },
        "vector_enabled": { "type": "boolean" },
        "rag_enabled": { "type": "boolean" },
        "aggressive_summary_enabled": { "type": "boolean" },
        "todo_tracking_enabled": { "type": "boolean" },
        "sub_agent_parallel_enabled": { "type": "boolean" },
        "sub_agent_output_caching_enabled": { "type": "boolean" },
        "dynamic_routing_enabled": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "dynamic_routing": {
      "type": "object",
      "required": [
        "enabled",
        "routing_policy",
        "task_keywords",
        "fallback_agent",
        "context_pressure_threshold",
        "routing_trace_enabled"
      ],
      "properties": {
        "enabled": { "type": "boolean" },
        "routing_policy": {
          "type": "string",
          "enum": ["hybrid", "task_type", "agent_capabilities", "context_pressure"]
        },
        "task_keywords": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "type": "string" }
          }
        },
        "fallback_agent": { "type": "string", "minLength": 1 },
        "context_pressure_threshold": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "routing_trace_enabled": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "retrieval": {
      "type": "object",
      "required": [
        "enabled",
        "keyword_top_k",
        "vector_top_k",
        "max_snippets",
        "max_snippet_chars",
        "vector_dimension",
        "min_vector_score",
        "inject_as_system_message",
        "context_expansion_lines",
        "ranking_recency_weight",
        "ranking_importance_weight",
        "rag_prompt_token_budget",
        "embedding_backend",
        "embedding_model",
        "embedding_base_url",
        "embedding_api_key_env"
      ],
      "properties": {
        "enabled": { "type": "boolean" },
        "keyword_top_k": { "type": "integer", "minimum": 0 },
        "vector_top_k": { "type": "integer", "minimum": 0 },
        "max_snippets": { "type": "integer", "minimum": 0 },
        "max_snippet_chars": { "type": "integer", "minimum": 1 },
        "vector_dimension": { "type": "integer", "minimum": 8 },
        "min_vector_score": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "inject_as_system_message": { "type": "boolean" },
        "context_expansion_lines": { "type": "integer", "minimum": 0 },
        "ranking_recency_weight": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "ranking_importance_weight": { "type": "number", "minimum": 0.0, "maximum": 1.0 },
        "rag_prompt_token_budget": { "type": "integer", "minimum": 64 },
        "embedding_backend": {
          "type": "string",
          "enum": [
            "deterministic_hash",
            "open_ai",
            "open_ai_compatible",
            "sentence_transformers"
          ]
        },
        "embedding_model": { "type": ["string", "null"] },
        "embedding_base_url": { "type": ["string", "null"] },
        "embedding_api_key_env": { "type": ["string", "null"] }
      },
      "additionalProperties": false
    },
    "mcp": {
      "type": "object",
      "required": ["servers"],
      "properties": {
        "servers": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "name",
              "command",
              "args",
              "env",
              "working_directory",
              "startup_timeout_seconds",
              "protocol_version"
            ],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "command": { "type": "string", "minLength": 1 },
              "args": {
                "type": "array",
                "items": { "type": "string" }
              },
              "env": {
                "type": "object",
                "additionalProperties": { "type": "string" }
              },
              "working_directory": { "type": ["string", "null"] },
              "startup_timeout_seconds": { "type": "integer", "minimum": 1 },
              "protocol_version": { "type": "string", "minLength": 1 }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "plugins": {
      "type": "object",
      "required": ["directories", "manifest_file_name", "max_discovery_depth"],
      "properties": {
        "directories": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "manifest_file_name": { "type": "string", "minLength": 1 },
        "max_discovery_depth": { "type": "integer", "minimum": 1, "maximum": 32 }
      },
      "additionalProperties": false
    },
    "skills": {
      "type": "object",
      "required": [
        "directories",
        "max_discovery_depth",
        "script_execution_mode",
        "default_timeout_seconds",
        "sandbox"
      ],
      "properties": {
        "directories": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "max_discovery_depth": { "type": "integer", "minimum": 1, "maximum": 32 },
        "script_execution_mode": { "type": "string", "enum": ["disabled", "host", "sandbox"] },
        "default_timeout_seconds": { "type": "integer", "minimum": 1 },
        "sandbox": {
          "type": "object",
          "required": ["enabled", "sandbox_type"],
          "properties": {
            "enabled": { "type": "boolean" },
            "sandbox_type": { "type": "string", "minLength": 1 }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "workflows": {
      "type": "object",
      "required": [
        "directories",
        "max_discovery_depth",
        "default_timeout_seconds",
        "compatibility_preset",
        "max_recursion_depth",
        "max_steps_per_run",
        "condition_group_max_depth",
        "expression_max_length",
        "expression_max_depth",
        "loop_default_max_iterations",
        "loop_default_max_parallelism",
        "loop_hard_max_parallelism",
        "wait_default_poll_interval_ms",
        "wait_default_timeout_seconds"
      ],
      "properties": {
        "directories": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "max_discovery_depth": { "type": "integer", "minimum": 1, "maximum": 32 },
        "default_timeout_seconds": { "type": "integer", "minimum": 1 },
        "compatibility_preset": {
          "type": "string",
          "enum": ["rustic", "open_code", "claude_code", "n8n"]
        },
        "switch_case_sensitive_default": { "type": ["boolean", "null"] },
        "switch_pattern_priority": {
          "type": ["string", "null"],
          "enum": ["exact_first", "pattern_first", null]
        },
        "loop_continue_on_iteration_error_default": { "type": ["boolean", "null"] },
        "wait_timeout_succeeds": { "type": ["boolean", "null"] },
        "condition_missing_path_as_false": { "type": ["boolean", "null"] },
        "default_continue_on_error": { "type": ["boolean", "null"] },
        "continue_on_error_routing": {
          "type": ["string", "null"],
          "enum": ["next_first", "on_failure_first", null]
        },
        "execution_error_policy": {
          "type": ["string", "null"],
          "enum": ["abort", "route_as_failure", null]
        },
        "timeout_error_policy": {
          "type": ["string", "null"],
          "enum": ["abort", "route_as_failure", null]
        },
        "default_retry_count": { "type": ["integer", "null"], "minimum": 0, "maximum": 20 },
        "default_retry_backoff_ms": { "type": ["integer", "null"], "minimum": 1, "maximum": 600000 },
        "default_retry_backoff_multiplier": { "type": ["number", "null"], "minimum": 1.0, "maximum": 10.0 },
        "default_retry_backoff_max_ms": { "type": ["integer", "null"], "minimum": 1, "maximum": 600000 },
        "max_recursion_depth": { "type": ["integer", "null"], "minimum": 1, "maximum": 256 },
        "max_steps_per_run": { "type": ["integer", "null"], "minimum": 1, "maximum": 10000 },
        "condition_group_max_depth": { "type": "integer", "minimum": 1, "maximum": 64 },
        "expression_max_length": { "type": "integer", "minimum": 16, "maximum": 65536 },
        "expression_max_depth": { "type": "integer", "minimum": 1, "maximum": 512 },
        "loop_default_max_iterations": { "type": "integer", "minimum": 1, "maximum": 1000000 },
        "loop_default_max_parallelism": { "type": "integer", "minimum": 1, "maximum": 10000 },
        "loop_hard_max_parallelism": { "type": "integer", "minimum": 1, "maximum": 10000 },
        "wait_default_poll_interval_ms": { "type": "integer", "minimum": 1, "maximum": 60000 },
        "wait_default_timeout_seconds": { "type": "integer", "minimum": 1, "maximum": 86400 }
      },
      "additionalProperties": false
    },
    "storage": {
      "type": "object",
      "required": [
        "backend",
        "default_root_dir_name",
        "project_database_file",
        "connection_string_prefix",
        "global_settings_file",
        "global_data_subdir",
        "pool_size",
        "sqlite",
        "postgres"
      ],
      "properties": {
        "backend": {
          "type": "string",
          "enum": ["sqlite", "postgres", "custom"]
        },
        "default_root_dir_name": { "type": "string", "minLength": 1 },
        "project_data_path": { "type": ["string", "null"] },
        "project_database_file": { "type": "string", "minLength": 1 },
        "connection_string_prefix": { "type": "string", "minLength": 1 },
        "global_root_path": { "type": ["string", "null"] },
        "global_settings_file": { "type": "string", "minLength": 1 },
        "global_data_subdir": { "type": "string", "minLength": 1 },
        "pool_size": { "type": "integer", "minimum": 1 },
        "sqlite": {
          "type": "object",
          "required": [
            "busy_timeout_ms",
            "journal_mode",
            "synchronous",
            "foreign_keys",
            "vector_extension_enabled",
            "vector_extension_path",
            "vector_extension_entrypoint",
            "vector_extension_strict"
          ],
          "properties": {
            "busy_timeout_ms": { "type": "integer", "minimum": 1 },
            "journal_mode": { "type": "string", "minLength": 1 },
            "synchronous": { "type": "string", "minLength": 1 },
            "foreign_keys": { "type": "boolean" },
            "vector_extension_enabled": { "type": "boolean" },
            "vector_extension_path": { "type": ["string", "null"] },
            "vector_extension_entrypoint": { "type": ["string", "null"] },
            "vector_extension_strict": { "type": "boolean" }
          },
          "additionalProperties": false
        },
        "postgres": {
          "type": "object",
          "required": ["connection_url", "schema_name"],
          "properties": {
            "connection_url": { "type": ["string", "null"] },
            "schema_name": { "type": ["string", "null"] }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "summarization": {
      "type": "object",
      "required": [
        "enabled",
        "provider_name",
        "max_context_tokens",
        "summary_max_tokens",
        "trigger_mode",
        "message_window_threshold",
        "token_threshold_percent",
        "include_user_task",
        "include_completion_summary",
        "quality_tracking_enabled",
        "user_rating_prompt"
      ],
      "properties": {
        "enabled": { "type": "boolean" },
        "provider_name": { "type": ["string", "null"] },
        "max_context_tokens": { "type": "integer", "minimum": 1 },
        "summary_max_tokens": { "type": "integer", "minimum": 1 },
        "trigger_mode": {
          "type": "string",
          "enum": ["hybrid", "fixed_message_count", "token_threshold", "turn_based"]
        },
        "message_window_threshold": { "type": ["integer", "null"], "minimum": 1 },
        "token_threshold_percent": { "type": ["number", "null"], "minimum": 0.0, "maximum": 1.0 },
        "include_user_task": { "type": "boolean" },
        "include_completion_summary": { "type": "boolean" },
        "quality_tracking_enabled": { "type": "boolean" },
        "user_rating_prompt": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "rules": {
      "type": "object",
      "required": [
        "global_rules_path",
        "project_rules_folder",
        "additional_search_paths",
        "recursive_discovery",
        "max_discovery_depth",
        "use_gitignore",
        "rule_extensions",
        "rule_file_names",
        "context_file_patterns",
        "context_extensions",
        "topic_debounce_interval_secs",
        "topic_similarity_threshold",
        "global_files",
        "project_files",
        "topic_files",
        "context_files",
        "discovered_rules"
      ],
      "properties": {
        "global_rules_path": { "type": "string" },
        "project_rules_folder": { "type": "string" },
        "additional_search_paths": {
          "type": "array",
          "items": { "type": "string" }
        },
        "recursive_discovery": { "type": "boolean" },
        "max_discovery_depth": { "type": "integer", "minimum": 0 },
        "use_gitignore": { "type": "boolean" },
        "rule_extensions": {
          "type": "array",
          "items": { "type": "string" }
        },
        "rule_file_names": {
          "type": "array",
          "items": { "type": "string" }
        },
        "context_file_patterns": {
          "type": "array",
          "items": { "type": "string" }
        },
        "context_extensions": {
          "type": "array",
          "items": { "type": "string" }
        },
        "topic_debounce_interval_secs": { "type": "integer", "minimum": 0 },
        "topic_similarity_threshold": { "type": "number", "minimum": 0, "maximum": 1 },
        "global_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "project_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "topic_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "context_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "discovered_rules": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "path",
              "scope",
              "globs",
              "always_apply",
              "applicability",
              "topics"
            ],
            "properties": {
              "path": { "type": "string" },
              "scope": { "type": "string", "enum": ["global", "project", "topic"] },
              "description": { "type": ["string", "null"] },
              "globs": {
                "type": "array",
                "items": { "type": "string" }
              },
              "always_apply": { "type": "boolean" },
              "applicability": {
                "type": "string",
                "enum": ["general", "context_specific"]
              },
              "topics": {
                "type": "array",
                "items": { "type": "string" }
              },
              "priority": { "type": ["integer", "null"] }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    },
    "permissions": {
      "type": "object",
      "required": [
        "default_tool_permission",
        "ask_decisions_persist_scope",
        "remember_denied_duration_secs",
        "globally_allowed_paths",
        "project_allowed_paths",
        "global_command_patterns",
        "project_command_patterns",
        "pending_tool_timeout_secs",
        "sudo_cache_ttl_secs",
        "permission_cache_max_entries",
        "read_only_shell_write_patterns"
      ],
      "properties": {
        "default_tool_permission": {
          "type": "string",
          "enum": ["allow", "ask", "deny"]
        },
        "ask_decisions_persist_scope": {
          "type": "string",
          "enum": ["session", "project", "global"]
        },
        "remember_denied_duration_secs": {
          "type": "integer",
          "minimum": 0
        },
        "globally_allowed_paths": {
          "type": "array",
          "items": { "type": "string" }
        },
        "project_allowed_paths": {
          "type": "array",
          "items": { "type": "string" }
        },
        "global_command_patterns": {
          "$ref": "#/$defs/command_pattern_config"
        },
        "project_command_patterns": {
          "$ref": "#/$defs/command_pattern_config"
        },
        "pending_tool_timeout_secs": {
          "type": "integer",
          "minimum": 1
        },
        "sudo_cache_ttl_secs": {
          "type": "integer",
          "minimum": 1
        },
        "permission_cache_max_entries": {
          "type": "integer",
          "minimum": 0
        },
        "read_only_shell_write_patterns": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": false
    },
    "providers": {
      "type": "array",
      "minItems": 1,
      "items": {
        "oneOf": [
          {
            "type": "object",
            "required": [
              "name",
              "provider_type",
              "auth_mode",
              "model",
              "base_url"
            ],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "provider_type": { "const": "open_ai" },
              "auth_mode": { "type": "string", "enum": ["api_key", "subscription", "none"] },
              "model": { "type": "string", "minLength": 1 },
              "api_key_env": { "type": ["string", "null"] },
              "base_url": { "type": "string", "minLength": 1 },
              "settings": {
                "type": ["object", "null"],
                "additionalProperties": true
              }
            },
            "additionalProperties": false
          },
          {
            "type": "object",
            "required": ["name", "provider_type", "auth_mode"],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "provider_type": {
                "type": "string",
                "enum": ["anthropic", "grok", "google", "z_ai", "ollama", "custom"]
              },
              "auth_mode": { "type": "string", "enum": ["api_key", "subscription", "none"] },
              "model": { "type": ["string", "null"] },
              "api_key_env": { "type": ["string", "null"] },
              "base_url": { "type": ["string", "null"] },
              "settings": {
                "type": ["object", "null"],
                "additionalProperties": true
              }
            },
            "additionalProperties": false
          }
        ]
      }
    },
    "agents": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["name", "provider", "tools", "skills"],
        "properties": {
          "name": { "type": "string", "minLength": 1 },
          "provider": { "type": "string", "minLength": 1 },
          "tools": {
            "type": "array",
            "items": { "type": "string" }
          },
          "skills": {
            "type": "array",
            "items": { "type": "string" }
          },
          "system_prompt_template": { "type": ["string", "null"] },
          "temperature": { "type": "number" },
          "max_tokens": { "type": "integer", "minimum": 1 },
          "context_window_size": { "type": "integer", "minimum": 1 },
          "max_tool_rounds": { "type": ["integer", "null"], "minimum": 0 },
          "max_tools_per_round": { "type": ["integer", "null"], "minimum": 0 },
          "max_total_tool_calls_per_turn": { "type": ["integer", "null"], "minimum": 0 },
          "max_turn_duration_seconds": { "type": ["integer", "null"], "minimum": 0 },
          "permission_mode": { "type": "string", "enum": ["read_only", "read_write"] },
          "allow_sub_agent_calls": { "type": "boolean" },
          "max_sub_agent_depth": { "type": ["integer", "null"], "minimum": 1 },
          "sub_agent_context_window_size": { "type": ["integer", "null"], "minimum": 1 },
          "sub_agent_max_context_tokens": { "type": ["integer", "null"], "minimum": 1 },
          "context_summary_enabled": { "type": ["boolean", "null"] },
          "context_summary_max_tokens": { "type": ["integer", "null"], "minimum": 1 },
          "context_summary_cache_entries": { "type": ["integer", "null"], "minimum": 1 },
          "tool_shortlist_mode": {
            "type": "string",
            "enum": ["full", "priority", "task_focused"]
          },
          "tool_shortlist_max_items": { "type": ["integer", "null"], "minimum": 1, "maximum": 256 },
          "tool_shortlist_char_budget": { "type": ["integer", "null"], "minimum": 1, "maximum": 32000 },
          "sub_agent_target_shortlist_enabled": { "type": ["boolean", "null"] },
          "sub_agent_target_shortlist_max_items": { "type": ["integer", "null"], "minimum": 1, "maximum": 64 },
          "sub_agent_target_shortlist_char_budget": { "type": ["integer", "null"], "minimum": 1, "maximum": 8000 },
          "auto_create_todos": { "type": "boolean" },
          "todo_project_scope": { "type": "boolean" },
          "parallel_sub_agent_enabled": { "type": "boolean" },
          "aggressive_delegation_policy": {
            "type": ["string", "null"],
            "enum": ["aggressive", "conservative", null]
          },
          "sub_agent_max_parallel_tasks": { "type": ["integer", "null"], "minimum": 0 },
          "sub_agent_output_cache_mode": {
            "type": "string",
            "enum": ["hybrid", "exact_match", "semantic"]
          },
          "sub_agent_output_cache_ttl_secs": { "type": ["integer", "null"], "minimum": 0 },
          "sub_agent_parallel_progress_enabled": { "type": "boolean" },
          "sub_agent_parallel_detailed_logs": { "type": "boolean" },
          "taxonomy_membership": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["basket", "sub_basket"],
              "properties": {
                "basket": { "type": "string" },
                "sub_basket": { "type": ["string", "null"] }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "tools": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "name",
          "enabled",
          "permission_mode",
          "timeout_seconds",
          "allowed_commands",
          "denied_commands",
          "working_dir",
          "custom_working_dir",
          "env_passthrough",
          "stream_output",
          "require_sudo",
          "privileged_command_patterns",
          "read_only_blocked_patterns"
        ],
        "properties": {
          "name": { "type": "string" },
          "enabled": { "type": "boolean" },
          "permission_mode": { "type": "string", "enum": ["allow", "ask", "deny"] },
          "timeout_seconds": { "type": "integer", "minimum": 1 },
          "allowed_commands": {
            "type": "array",
            "items": { "type": "string" }
          },
          "denied_commands": {
            "type": "array",
            "items": { "type": "string" }
          },
          "working_dir": {
            "type": "string",
            "enum": ["current", "project_root", "custom_path"]
          },
          "custom_working_dir": { "type": ["string", "null"] },
          "env_passthrough": { "type": "boolean" },
          "stream_output": { "type": "boolean" },
          "require_sudo": { "type": "boolean" },
          "privileged_command_patterns": {
            "type": "array",
            "items": { "type": "string" }
          },
          "read_only_blocked_patterns": {
            "type": "array",
            "items": { "type": "string" }
          },
          "taxonomy_membership": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["basket", "sub_basket"],
              "properties": {
                "basket": { "type": "string" },
                "sub_basket": { "type": ["string", "null"] }
              },
              "additionalProperties": false
            }
          }
        },
        "additionalProperties": false
      }
    },
    "taxonomy": {
      "type": "object",
      "required": ["baskets"],
      "properties": {
        "baskets": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "sub_baskets"],
            "properties": {
              "name": { "type": "string" },
              "sub_baskets": {
                "type": "array",
                "items": { "type": "string" }
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    }
  },
  "$defs": {
    "command_pattern_config": {
      "type": "object",
      "required": ["allow", "ask", "deny"],
      "properties": {
        "allow": {
          "type": "array",
          "items": { "type": "string" }
        },
        "ask": {
          "type": "array",
          "items": { "type": "string" }
        },
        "deny": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
